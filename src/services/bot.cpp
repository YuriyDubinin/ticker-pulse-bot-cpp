#include "bot.h"
#include <chrono>
#include <fmt/core.h>
#include <string>
#include <thread>
#include <vector>
#include "common_utils.h"
#include "global_config.h"
#include "http_client.h"
#include "thread_pool.h"

Bot::Bot(const std::string& token, int threads_count, const std::string& db_connection_info)
    : bot(token), pool(threads_count), http_client(), db(db_connection_info), newsDAO(db) {};

void Bot::start() {
  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /start
  // bot.getEvents().onCommand("start", [this](TgBot::Message::Ptr message) {
  //     on_start_command(message);
  // });

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /help
  // bot.getEvents().onCommand("help", [this](TgBot::Message::Ptr message) {
  //    bot.getApi().sendMessage(message->chat->id,
  //     "ðŸ“” Ð¡Ð¿Ð¸ÑÐ¾Ðº ÐºÐ¾Ð¼Ð°Ð½Ð´ Ð±Ð¾Ñ‚Ð°:\n\n"
  //     "/start - ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ñ Ð±Ð¾Ñ‚Ð¾Ð¼\n"
  //     "/help - ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÐ¿Ñ€Ð°Ð²ÐºÑƒ Ð¿Ð¾ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð°Ð¼\n"
  //     "/info - ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ð±Ð¾Ñ‚Ðµ"
  //     );
  // });

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /info
  // bot.getEvents().onCommand("info", [this](TgBot::Message::Ptr message) {
  //    bot.getApi().sendMessage(message->chat->id,
  //     "â„¹ï¸ Ð‘Ð¾Ñ‚ Ð¿Ñ€ÐµÐ´Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½ Ð´Ð»Ñ Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ ÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð²Ð°Ð»ÑŽÑ‚Ðµ, Ð½Ð° Ð´Ð°Ð½Ð½Ñ‹Ð¹ Ð¼Ð¾ÐµÐ½Ñ‚ Ð½Ð°Ñ…Ð¾Ð´Ð¸Ñ‚ÑÑ Ð½Ð° ÑÑ‚Ð°Ð´Ð¸Ð¸
  //     Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸."
  //     );
  // });

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
  // bot.getEvents().on_any_message([this](TgBot::Message::Ptr message) {
  //     // on_any_message(message);
  // });

  try {
    // const std::string start_chat_message = "ðŸš€ Ticker Pulse Bot Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½..";
    // send_message_to_group(TELEGRAM_GROUP_ID, start_chat_message);

    fmt::print("[TICKER_PULSE_BOT]: TG username - {}\n", bot.getApi().getMe()->username);

    pool.enqueue_task([this]() {
      publish_news_by_interval(PUBLISH_NEWS_INTERVAL);
    });

    // Ð—Ð°Ð¿ÑƒÑÐº long polling
    TgBot::TgLongPoll longPoll(bot);
    fmt::print("[TICKER_PULSE_BOT]: Long poll started\n");

    while (true) {
      // fmt::print("[TICKER_PULSE_BOT]: Long poll started\n");
      longPoll.start();
    }
  } catch (TgBot::TgException& e) {
    fmt::print("[TICKER_PULSE_BOT]: {}\n", e.what());
  };
};

void Bot::on_start_command(TgBot::Message::Ptr message) {
  TgBot::InlineKeyboardMarkup::Ptr main_keyboard = create_main_keyboard();
  bot.getApi().sendMessage(message->chat->id, "ðŸ“Š ÐŸÑ€Ð¸Ð²ÐµÑ‚! Ð¯ Ð¾Ñ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°ÑŽ ÐºÑƒÑ€ÑÑ‹ ÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð²Ð°Ð»ÑŽÑ‚. ðŸš€", false, 0, main_keyboard);
};

void Bot::on_any_message(TgBot::Message::Ptr message) {
  fmt::print("[TICKER_PULSE_BOT]: [CHAT]: {}\n", message->text);

  if (message->text.find("/start") != 0 && message->text.find("/help") != 0 && message->text.find("/info") != 0) {
    bot.getApi().sendMessage(message->chat->id,
                             "ÐÐµ Ð¿Ð¾Ð½Ð¸Ð¼Ð°ÑŽ Ñ‡Ñ‚Ð¾ Ð´ÐµÐ»Ð°Ñ‚ÑŒ Ñ " + message->text +
                                 ".\nðŸ“” Ð¡Ð¿Ð¸ÑÐ¾Ðº ÐºÐ¾Ð¼Ð°Ð½Ð´ Ð±Ð¾Ñ‚Ð°:\n\n"
                                 "/start - ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ñ Ð±Ð¾Ñ‚Ð¾Ð¼\n"
                                 "/help - ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÐ¿Ñ€Ð°Ð²ÐºÑƒ Ð¿Ð¾ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð°Ð¼\n"
                                 "/info - ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ð±Ð¾Ñ‚Ðµ");
  }
};

void Bot::send_message_to_group(const std::string& group_id, const std::string& message_text) {
  try {
    bot.getApi().sendMessage(group_id, message_text);
    fmt::print("[TICKER_PULSE_BOT]: Message sent to group {}\n", group_id);
  } catch (TgBot::TgException& e) {
    fmt::print("[TICKER_PULSE_BOT]: Failed to send message to group {}: {}\n", group_id, e.what());
  };
};

TgBot::InlineKeyboardMarkup::Ptr Bot::create_main_keyboard() {
  TgBot::InlineKeyboardMarkup::Ptr keyboard(new TgBot::InlineKeyboardMarkup);

  // Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÐºÐ½Ð¾Ð¿Ð¾Ðº
  TgBot::InlineKeyboardButton::Ptr button1(new TgBot::InlineKeyboardButton);
  button1->text         = "ðŸ“ˆ ÐšÑƒÑ€Ñ Ð²ÐµÐ´ÑƒÑ‰Ð¸Ñ… Ð²Ð°Ð»ÑŽÑ‚";
  button1->callbackData = "ACTUAL";

  // TgBot::InlineKeyboardButton::Ptr button3(new TgBot::InlineKeyboardButton);
  // button3->text = "ðŸ“” ÐšÐ¾Ð¼Ð°Ð½Ð´Ñ‹";
  // button3->callbackData = "ATIONS";

  // TgBot::InlineKeyboardButton::Ptr button4(new TgBot::InlineKeyboardButton);
  // button4->text = "â„¹ï¸ Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ";
  // button4->callbackData = "INFO";

  // Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÐ½Ð¾Ð¿Ð¾Ðº Ð² Ñ€ÑÐ´Ñ‹
  keyboard->inlineKeyboard.push_back({button1});
  // keyboard->inlineKeyboard.push_back({button3, button4});

  return keyboard;
};

void Bot::publish_news_by_interval(const unsigned int minutes) {
  while (true) {
    auto news_opt = newsDAO.get_latest_unpublished();

    if (news_opt.has_value()) {
      News        news         = news_opt.value();
      std::string message_text = fmt::format("{}. @ticker_pulse\nðŸ”— ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½ÐµÐµ: {}", news.title, news.link.value_or(""));

      send_message_to_group(TELEGRAM_GROUP_ID, message_text);

      news.published = true;

      if (newsDAO.update(news)) {
        // fmt::print("[TICKER_PULSE_BOT]: News with id {} marked as published.\n", news.id);
      } else {
        // fmt::print("[TICKER_PULSE_BOT]: Failed to update news with id {}.\n", news.id);
      }
    }

    std::this_thread::sleep_for(std::chrono::minutes(minutes));
  }
}
